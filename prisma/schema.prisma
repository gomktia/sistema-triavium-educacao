generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model assessments {
  id                 String          @id
  tenantId           String
  studentId          String
  type               AssessmentType
  screeningWindow    ScreeningWindow
  academicYear       Int
  appliedAt          DateTime        @default(now())
  screeningTeacherId String?
  rawAnswers         Json
  processedScores    Json?
  overallTier        RiskTier?
  externalizingScore Int?
  internalizingScore Int?
  selfKnowledgeScore Int?
  createdAt          DateTime        @default(now())
  updatedAt          DateTime
  users              users?          @relation(fields: [screeningTeacherId], references: [id])
  students           students        @relation(fields: [studentId], references: [id], onDelete: Cascade)
  tenants            tenants         @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([studentId, type, appliedAt])
  @@index([tenantId])
  @@index([tenantId, overallTier])
  @@index([tenantId, studentId])
  @@index([tenantId, type, screeningWindow, academicYear])
}

model audit_logs {
  id        String   @id
  userId    String
  action    String
  targetId  String?
  details   Json?
  timestamp DateTime @default(now())
  ip        String?
  users     users    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([action])
  @@index([userId])
}

model classrooms {
  id                 String               @id
  tenantId           String
  name               String
  grade              GradeLevel
  year               Int
  shift              String?
  createdAt          DateTime             @default(now())
  tenants            tenants              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  students           students[]
  teacher_classrooms teacher_classrooms[]

  @@unique([tenantId, name, year])
  @@index([tenantId])
}

model form_questions {
  id               String           @id
  number           Int
  text             String
  category         String?
  type             AssessmentType
  isActive         Boolean          @default(true)
  createdAt        DateTime         @default(now())
  updatedAt        DateTime
  order            Int              @default(0)
  weight           Int              @default(1)
  tenantId         String?
  educationalLevel EducationalLevel @default(HIGH_SCHOOL)
  tenants          tenants?         @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, type, number])
}

model grade_focus_config {
  id            Int           @id @default(autoincrement())
  grade         GradeLevel
  focus_label   String
  srss_item     Int
  severity      String
  rationale_pt  String
  srss_ie_items srss_ie_items @relation(fields: [srss_item], references: [item_number])

  @@unique([grade, srss_item])
}

model intervention_groups {
  id          String           @id
  tenantId    String
  name        String
  description String?
  type        InterventionType
  startDate   DateTime
  endDate     DateTime?
  isActive    Boolean          @default(true)
  tenants     tenants          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  students    students[]       @relation("InterventionGroupToStudent")

  @@index([tenantId])
}

model intervention_logs {
  id                String             @id
  tenantId          String
  studentId         String
  authorId          String
  type              InterventionType
  status            InterventionStatus @default(PLANNED)
  tier              RiskTier
  title             String
  description       String?
  goals             String?
  observations      String?
  leverageStrengths String[]
  targetRisks       String[]
  startDate         DateTime?
  endDate           DateTime?
  nextReview        DateTime?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime
  users             users              @relation(fields: [authorId], references: [id])
  students          students           @relation(fields: [studentId], references: [id], onDelete: Cascade)
  tenants           tenants            @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([tenantId, status])
  @@index([tenantId, studentId])
  @@index([tenantId, tier])
}

model intervention_plans {
  id                String    @id
  tenantId          String
  studentId         String
  authorId          String
  status            String    @default("ACTIVE")
  targetRisks       String[]
  leverageStrengths String[]
  strategicActions  String
  expectedOutcome   String?
  reviewDate        DateTime?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime
  users             users     @relation(fields: [authorId], references: [id])
  students          students  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  tenants           tenants   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([studentId])
  @@index([tenantId])
}

model notifications {
  id        String           @id
  tenantId  String
  userId    String?
  studentId String?
  type      NotificationType
  title     String
  message   String
  isRead    Boolean          @default(false)
  link      String?
  createdAt DateTime         @default(now())
  students  students?        @relation(fields: [studentId], references: [id])
  tenants   tenants          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  users     users?           @relation(fields: [userId], references: [id])

  @@index([tenantId, createdAt])
  @@index([tenantId])
  @@index([tenantId, userId, isRead])
}

model school_indicators {
  id               String   @id
  tenantId         String
  studentId        String
  academicYear     Int
  quarter          Int
  attendanceRate   Float
  academicAverage  Float
  disciplinaryLogs Int      @default(0)
  previousAverage  Float?
  createdAt        DateTime @default(now())
  updatedAt        DateTime
  students         students @relation(fields: [studentId], references: [id], onDelete: Cascade)
  tenants          tenants  @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([studentId, academicYear, quarter])
  @@index([tenantId])
}

model srss_ie_cutoffs {
  id        Int      @id @default(autoincrement())
  domain    String
  tier      RiskTier
  min_score Int
  max_score Int
  color     String
  action_pt String

  @@unique([domain, tier])
}

model srss_ie_items {
  id                 Int                  @id @default(autoincrement())
  item_number        Int                  @unique
  text_pt            String
  domain             String
  max_score          Int                  @default(3)
  grade_focus_config grade_focus_config[]
}

model student_invitations {
  id              String    @id
  token           String    @unique
  tenantId        String
  email           String?
  status          String    @default("PENDING")
  usedByStudentId String?
  expiresAt       DateTime?
  createdAt       DateTime  @default(now())
  tenants         tenants   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([token])
}

model students {
  id                  String                @id
  tenantId            String
  name                String
  birthDate           DateTime?
  grade               GradeLevel
  classroomId         String?
  enrollmentId        String?
  guardianName        String?
  guardianPhone       String?
  guardianEmail       String?
  isActive            Boolean               @default(true)
  isFormEnabled       Boolean               @default(false)
  createdAt           DateTime              @default(now())
  updatedAt           DateTime
  formAccessExpiresAt DateTime?
  cpf                 String?
  accessCode          String?               @unique
  consentAcceptedAt   DateTime?
  assessments         assessments[]
  intervention_logs   intervention_logs[]
  intervention_plans  intervention_plans[]
  notifications       notifications[]
  school_indicators   school_indicators[]
  classrooms          classrooms?           @relation(fields: [classroomId], references: [id])
  tenants             tenants               @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  users               users?
  intervention_groups intervention_groups[] @relation("InterventionGroupToStudent")

  @@unique([tenantId, cpf])
  @@unique([tenantId, enrollmentId])
  @@index([classroomId])
  @@index([tenantId, grade])
  @@index([tenantId])
}

model teacher_classrooms {
  id          String     @id
  teacherId   String
  classroomId String
  tenantId    String
  createdAt   DateTime   @default(now())
  classrooms  classrooms @relation(fields: [classroomId], references: [id], onDelete: Cascade)
  users       users      @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  tenants     tenants    @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([teacherId, classroomId])
  @@index([classroomId])
  @@index([teacherId])
  @@index([tenantId])
}

model tenants {
  id                  String                @id
  name                String
  slug                String                @unique
  cnpj                String?               @unique
  address             String?
  city                String?
  state               String?               @db.VarChar(2)
  phone               String?
  email               String?
  logoUrl             String?
  organizationType    OrganizationType      @default(EDUCATIONAL)
  onboardingCompleted Boolean               @default(false)
  isActive            Boolean               @default(true)
  subscriptionStatus  String                @default("active")
  createdAt           DateTime              @default(now())
  updatedAt           DateTime
  assessments         assessments[]
  classrooms          classrooms[]
  form_questions      form_questions[]
  intervention_groups intervention_groups[]
  intervention_logs   intervention_logs[]
  intervention_plans  intervention_plans[]
  notifications       notifications[]
  school_indicators   school_indicators[]
  student_invitations student_invitations[]
  students            students[]
  teacher_classrooms  teacher_classrooms[]
  users               users[]
}

model users {
  id                 String               @id
  tenantId           String
  email              String
  name               String
  role               Role
  supabaseUid        String?
  isActive           Boolean              @default(true)
  createdAt          DateTime             @default(now())
  updatedAt          DateTime
  studentId          String?              @unique
  cpf                String?
  assessments        assessments[]
  audit_logs         audit_logs[]
  intervention_logs  intervention_logs[]
  intervention_plans intervention_plans[]
  notifications      notifications[]
  teacher_classrooms teacher_classrooms[]
  students           students?            @relation(fields: [studentId], references: [id])
  tenants            tenants              @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, cpf])
  @@unique([tenantId, email])
  @@unique([tenantId, supabaseUid])
  @@index([supabaseUid])
  @@index([tenantId])
}

model via_question_items {
  id          Int    @id @default(autoincrement())
  item_number Int    @unique
  text_pt     String
  strength    String
  virtue      String
  max_score   Int    @default(4)
}

model via_strength_mapping {
  id           Int    @id @default(autoincrement())
  strength_id  Int    @unique
  strength     String
  virtue       String
  item_numbers Int[]
  max_possible Int
}

enum AssessmentType {
  VIA_STRENGTHS
  SRSS_IE
}

enum EducationalLevel {
  KINDERGARTEN
  ELEMENTARY
  HIGH_SCHOOL
}

enum GradeLevel {
  ANO_1_EM
  ANO_2_EM
  ANO_3_EM
}

enum InterventionStatus {
  PLANNED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum InterventionType {
  SOCIAL_SKILLS_GROUP
  EMOTION_REGULATION
  CAREER_GUIDANCE
  PEER_MENTORING
  STUDY_SKILLS
  INDIVIDUAL_PLAN
  PSYCHOLOGIST_REFERRAL
  EXTERNAL_REFERRAL
  CRISIS_PROTOCOL
  FAMILY_MEETING
  CHECK_IN_CHECK_OUT
}

enum NotificationType {
  CRITICAL_RISK
  NEW_ASSESSMENT
  INTERVENTION_DUE
  SYSTEM_ALERT
}

enum OrganizationType {
  EDUCATIONAL
  MILITARY
  CORPORATE
  SPORTS
}

enum RiskTier {
  TIER_1
  TIER_2
  TIER_3
}

enum Role {
  ADMIN
  MANAGER
  PSYCHOLOGIST
  COUNSELOR
  TEACHER
  STUDENT
}

enum ScreeningWindow {
  DIAGNOSTIC
  MONITORING
  FINAL
}
